<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, private">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ì„œë¹„ìŠ¤ ë“±ë¡ ìš”ì²­</title>
    <style>
        :root {
            --brand: #4CAF50;
            --blue: #2962FF;
            --danger: #f44336;
            --muted: #6b7280;
            --line: #e5e7eb;
            --bg: #f5f7fb;
            --hero: #3f8cff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
            background: var(--bg);
            color: #111;
            padding-bottom: 80px;
        }

        .page {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 12px 24px;
        }

        /* HERO */
        .hero {
            margin: 12px 0 0;
            padding: 24px 20px 20px;
            border-radius: 16px 16px 0 0;
            background: var(--hero);
            color: #fff;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .hero-title {
            text-align: center;
            font-size: 24px;
            font-weight: 800;
        }

        .stat-row {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 10px;
        }

        .stat-card {
            background: #fff;
            color: #111;
            border-radius: 12px;
            padding: 10px 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, .12);
        }

        .stat-title {
            font-size: 12px;
            color: #555;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .stat-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 3px 10px;
            border-radius: 999px;
            background: #2962FF;
            color: #fff;
            font-size: 11px;
            border: none;
            cursor: pointer;
        }

        /* FILTER */
        .filter-wrap {
            background: #fff;
            padding: 16px 18px 14px;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, .12);
            border: 1px solid #e0e7ff;
            border-top: none;
            margin-bottom: 14px;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .filter-title {
            font-size: 18px;
            font-weight: 700;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 7px 12px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: .15s;
        }

        .btn:hover {
            background: #f9fafb;
        }

        .btn-primary {
            background: var(--brand);
            border-color: var(--brand);
            color: #fff;
        }

        .btn-primary:hover {
            filter: brightness(.96);
        }

        .btn-secondary {
            background: #1e40af;
            border-color: #1e40af;
            color: #fff;
        }

        .btn-secondary:hover {
            filter: brightness(.96);
        }

        .btn-danger {
            background: var(--danger);
            border-color: var(--danger);
            color: #fff;
        }

        .btn-danger:hover {
            filter: brightness(.96);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-item label {
            font-size: 12px;
            font-weight: 700;
            color: #555;
        }

        .filter-item input[type="text"],
        .filter-item input[type="date"],
        .filter-item select {
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 13px;
            min-width: 120px;
        }

        .filter-item.search {
            flex: 1;
            min-width: 200px;
        }

        /* TOOLBAR & TABLE */
        .toolbar {
            margin-top: 14px;
            background: #3f51b5;
            border-radius: 12px 12px 0 0;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        .toolbar-left {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-save {
            background: #00c853;
            border-color: #00c853;
            color: #fff;
        }

        .btn-load {
            background: #2196f3;
            border-color: #2196f3;
            color: #fff;
        }

        .table-wrap {
            background: #fff;
            border-radius: 0 0 12px 12px;
            border: 1px solid #e0e7ff;
            border-top: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .06);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: #f1f5ff;
        }

        th,
        td {
            padding: 7px 8px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
            white-space: nowrap;
        }

        th {
            font-size: 12px;
            color: #555;
        }

        tbody tr:nth-child(even) {
            background: #fafbff;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .status-select {
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 12px;
            background: #fff;
        }

        .cell-actions a {
            font-size: 12px;
            margin-right: 6px;
            color: #1976d2;
            cursor: pointer;
            text-decoration: underline;
        }

        .cell-actions a.copy {
            color: #009688;
            /* ë³µì‚¬ ë²„íŠ¼ ìƒ‰ìƒ êµ¬ë¶„ */
        }

        .cell-actions a.delete {
            color: #d32f2f;
        }

        /* FAB */
        .fab {
            position: fixed;
            right: 18px;
            bottom: 18px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: #2196f3;
            box-shadow: 0 6px 16px rgba(0, 0, 0, .25);
            color: #fff;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 8000;
        }

        /* TOAST */
        .toast {
            position: fixed;
            top: 14px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            display: none;
            z-index: 9000;
            box-shadow: 0 8px 26px rgba(0, 0, 0, .6);
            max-width: 90vw;
            text-align: center;
            white-space: pre-line;
            /* ì¤„ë°”ê¿ˆ í—ˆìš© */
        }

        .toast.show {
            display: block;
            animation: toastDown .25s cubic-bezier(.34, 1.56, .64, 1);
        }

        @keyframes toastDown {
            from {
                transform: translate(-50%, -26px);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* MODALS */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, .7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 8500;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-inner {
            width: min(960px, 96vw);
            max-height: 92vh;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 18px 50px rgba(0, 0, 0, .45);
            padding: 12px 14px 16px;
            overflow: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 22px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 999px;
            color: #6b7280;
        }

        .modal-close:hover {
            background: #f3f4f6;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .form-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-item label {
            font-size: 12px;
            font-weight: 700;
            color: #555;
        }

        .form-item input[type="text"],
        .form-item input[type="email"],
        .form-item input[type="tel"],
        .form-item input[type="date"],
        .form-item select {
            padding: 7px 9px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 13px;
        }

        .form-actions {
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        .muted {
            font-size: 12px;
            color: var(--muted);
        }

        /* ì‚­ì œí™•ì¸ */
        .confirm-inner {
            width: min(380px, 94vw);
            max-height: 80vh;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 18px 50px rgba(0, 0, 0, .45);
            padding: 12px 14px 16px;
            overflow: auto;
        }

        @media (max-width:960px) {
            .stat-row {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        @media (max-width:720px) {
            .hero-title {
                font-size: 20px;
            }

            .stat-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width:540px) {
            .stat-row {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-item {
                width: 100%;
            }

            .filter-item input,
            .filter-item select {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <!-- HERO + STATS -->
        <section class="hero">
            <div class="hero-title">ì„œë¹„ìŠ¤ ë“±ë¡ ìš”ì²­</div>
            <div class="stat-row">
                <div class="stat-card">
                    <div class="stat-title">ì´ ë“±ë¡ ìˆ˜(ì§„í–‰ì¤‘)</div>
                    <div class="stat-value" id="statTotalActive">0</div>
                    <button class="stat-btn" type="button">ì¡°íšŒ</button>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ì¢…ë£Œ 30ì¼ ë‚¨ì€ ê±´ìˆ˜</div>
                    <div class="stat-value" id="stat30">0</div>
                    <button class="stat-btn" type="button">ì¡°íšŒ</button>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ì¢…ë£Œ 3ì¼ ë‚¨ì€ ê±´ìˆ˜</div>
                    <div class="stat-value" id="stat3">0</div>
                    <button class="stat-btn" type="button">ì¡°íšŒ</button>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ê¸ˆì¼ ì¢…ë£Œ ê±´ìˆ˜</div>
                    <div class="stat-value" id="statToday">0</div>
                    <button class="stat-btn" type="button">ì¡°íšŒ</button>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ê¸°ê°„ ì¢…ë£Œ ê±´ìˆ˜</div>
                    <div class="stat-value" id="statEnded">0</div>
                    <button class="stat-btn" type="button">ì¡°íšŒ</button>
                </div>
            </div>
        </section>

        <!-- FILTER -->
        <section class="filter-wrap">
            <div class="filter-header">
                <div class="filter-title">í•„í„°</div>
                <button class="btn btn-sm" id="btnToggleFilter" type="button">ì ‘ê¸°</button>
            </div>
            <div class="filters" id="filtersBody">
                <div class="filter-item">
                    <label>êµ¬ë¶„</label>
                    <select id="filterCategory">
                        <option value="">ì „ì²´</option>
                    </select>
                </div>
                <div class="filter-item search">
                    <label>ê¸°ê´€ëª… ê²€ìƒ‰</label>
                    <input type="text" id="filterName" placeholder="í•™ì›ëª…/í•™êµëª…/ê¸°ê´€ëª…">
                </div>
                <div class="filter-item">
                    <label>ë‚ ì§œ êµ¬ë¶„</label>
                    <select id="filterDateType">
                        <option value="requestDate">ìš”ì²­ë‚ ì§œ</option>
                        <option value="startDate">ì‹œì‘ë‚ ì§œ</option>
                        <option value="endDate">ì¢…ë£Œë‚ ì§œ</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>ë‚ ì§œ ì‹œì‘</label>
                    <input type="date" id="filterStart">
                </div>
                <div class="filter-item">
                    <label>ë‚ ì§œ ì¢…ë£Œ</label>
                    <input type="date" id="filterEnd">
                </div>
                <div class="filter-item">
                    <label>ìƒíƒœ</label>
                    <select id="filterStatus">
                        <option value="">ì „ì²´</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>ì •ë ¬</label>
                    <select id="filterSort">
                        <option value="requestDateDesc">ìš”ì²­ì¼ ìµœì‹ ìˆœ</option>
                        <option value="requestDateAsc">ìš”ì²­ì¼ ì˜¤ë˜ëœìˆœ</option>
                        <option value="endDateAsc">ì¢…ë£Œì¼ ì„ë°•ìˆœ</option>
                        <option value="endDateDesc">ì¢…ë£Œì¼ ë¨¼ìˆœ</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>&nbsp;</label>
                    <div style="display:flex;gap:6px;">
                        <button class="btn btn-sm" id="btnResetFilter" type="button">í•„í„° ì´ˆê¸°í™”</button>
                        <button class="btn btn-primary btn-sm" id="btnSearch" type="button">ê²€ìƒ‰</button>
                        <button class="btn btn-primary btn-sm" id="btnWriteRequest" type="button">ì‘ì„±</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- TOOLBAR + TABLE -->
        <section style="margin-top:10px;">
            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="btn btn-save" id="btnSave" type="button">ğŸ’¾ ì„œë²„ì— ì €ì¥</button>
                    <button class="btn btn-load" id="btnLoad" type="button">ğŸ“¥ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
                <div class="muted" id="summaryLabel">ì´ 0ê±´</div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>êµ¬ë¶„</th>
                            <th>ì„œë¹„ìŠ¤</th>
                            <th>ê¸°ê´€ëª…</th>
                            <th>ìš”ì²­ì</th>
                            <th>ì´ë©”ì¼</th>
                            <th>ì—°ë½ì²˜</th>
                            <th>í•¸ë“œí°ë²ˆí˜¸</th>
                            <th>ë¹„ë°€ë²ˆí˜¸</th>
                            <th>ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸</th>
                            <th>ìš”ì²­ë‚ ì§œ</th>
                            <th>ì‹œì‘ë‚ ì§œ</th>
                            <th>ì¢…ë£Œë‚ ì§œ</th>
                            <th>ìƒíƒœ</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- FAB (ì‘ì„± ë²„íŠ¼) -->
    <div class="fab" id="btnFab">+</div>

    <!-- ì‹ ê·œ ìš”ì²­ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="entryModal">
        <div class="modal-inner">
            <div class="modal-header">
                <div class="modal-title">ì‹ ê·œ ìš”ì²­ ë“±ë¡</div>
                <button class="modal-close" type="button" id="entryClose">Ã—</button>
            </div>
            <div class="muted" id="entryModeLabel" style="margin-bottom:6px;">ì‹ ê·œ ë“±ë¡ ëª¨ë“œ</div>
            <div class="form-grid">
                <div class="form-item">
                    <label>êµ¬ë¶„</label>
                    <select id="fCategory"></select>
                </div>
                <div class="form-item">
                    <label>ì„œë¹„ìŠ¤</label>
                    <select id="fService"></select>
                </div>
                <div class="form-item">
                    <label>ê¸°ê´€ëª…</label>
                    <input type="text" id="fName">
                </div>

                <!-- ìš”ì²­ì: ë“œë¡­ë‹¤ìš´ + ì§ì ‘ì…ë ¥ -->
                <div class="form-item">
                    <label>ìš”ì²­ì</label>
                    <select id="fRequesterSelect">
                        <option value="">ì„ íƒ</option>
                        <option value="í™í˜œìˆ™">í™í˜œìˆ™</option>
                        <option value="ì¡°í˜œì£¼">ì¡°í˜œì£¼</option>
                        <option value="ì´ë™ìš±">ì´ë™ìš±</option>
                        <option value="ì¡°ë³´ê¸ˆ">ì¡°ë³´ê¸ˆ</option>
                        <option value="ìœ ë•ê²½">ìœ ë•ê²½</option>
                        <option value="__custom__">ì§ì ‘ì…ë ¥</option>
                    </select>
                    <input type="text" id="fRequesterCustom" placeholder="ìš”ì²­ì ì§ì ‘ ì…ë ¥"
                        style="display:none;margin-top:4px;">
                </div>

                <div class="form-item">
                    <label>ì´ë©”ì¼</label>
                    <input type="email" id="fEmail">
                </div>
                <div class="form-item">
                    <label>ì—°ë½ì²˜</label>
                    <input type="tel" id="fContact">
                </div>
                <div class="form-item">
                    <label>í•¸ë“œí°ë²ˆí˜¸</label>
                    <input type="tel" id="fPhone">
                </div>
                <div class="form-item">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="text" id="fPassword">
                </div>
                <div class="form-item">
                    <label>ë§ˆìŠ¤í„° ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="text" id="fMasterPassword">
                </div>
                <div class="form-item">
                    <label>ìš”ì²­ë‚ ì§œ</label>
                    <input type="date" id="fRequestDate">
                </div>
                <div class="form-item">
                    <label>ì‹œì‘ë‚ ì§œ</label>
                    <input type="date" id="fStartDate">
                </div>
                <div class="form-item">
                    <label>ì¢…ë£Œë‚ ì§œ</label>
                    <input type="date" id="fEndDate">
                </div>
                <div class="form-item">
                    <label>ìƒíƒœ</label>
                    <select id="fStatus"></select>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-danger btn-sm" type="button" id="btnDeleteEntry" style="display:none;">ì„ íƒ ìš”ì²­
                    ì‚­ì œ</button>
                <div style="display:flex;gap:6px;">
                    <button class="btn btn-sm" type="button" id="btnClearForm">ì…ë ¥ ì´ˆê¸°í™”</button>
                    <button class="btn btn-primary" type="button" id="btnSaveEntry">ë“±ë¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="deleteModal">
        <div class="confirm-inner">
            <div class="modal-header">
                <div class="modal-title">ì‚­ì œ í™•ì¸</div>
                <button class="modal-close" type="button" id="deleteClose">Ã—</button>
            </div>
            <p style="font-size:13px;line-height:1.5;margin-bottom:10px;">
                ì„ íƒí•˜ì‹  ìš”ì²­ì„ <b>ì‚­ì œ</b>í•˜ë©´ ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </p>
            <div class="form-actions" style="justify-content:flex-end;">
                <button class="btn btn-sm" type="button" id="btnDeleteCancel">ì·¨ì†Œ</button>
                <button class="btn btn-danger btn-sm" type="button" id="btnDeleteOk">ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        /* ===== ê³µí†µ ìœ í‹¸ ===== */
        const FILE_NAME = "data/service_requests.json";
        const ENDPOINTS = {
            basePath: "",
            save: ["save.php", "api.php"],
            load: ["load.php", "api.php"],
            fallbackJson: "data/service_requests.json"
        };
        const BACKUP_KEY = "service_requests_backup";

        const DEFAULT_META = {
            categories: ["í•™êµ", "ê¸°ê´€", "í•™ì›", "ì‹œë‹ˆì–´100", "ê¸°íƒ€"],
            services: ["ìŠ¤ë§ˆíŠ¸ë“œëŸ¼", "ì‹œë‹ˆì–´ìŠ¤ë§ˆíŠ¸ë“œëŸ¼", "ìŠ¤ë§ˆíŠ¸í”¼ì•„ë…¸", "ìŠ¤ë§ˆíŠ¸ì•„íŠ¸í†¡í†¡", "ìŠ¤ë§ˆíŠ¸ë®¤ì§í”Œë ˆì´"],
            statuses: ["ì§„í–‰ì¤‘", "ì¢…ë£Œ", "ë³´ë¥˜"]
        };

        const REQUESTERS = ["í™í˜œìˆ™", "ì¡°í˜œì£¼", "ì´ë™ìš±", "ì¡°ë³´ê¸ˆ", "ìœ ë•ê²½"];

        const INITIAL_RECORDS_RAW = [
            {
                "category": "í•™êµ",
                "service": "ìŠ¤ë§ˆíŠ¸í”¼ì•„ë…¸",
                "name": "ë‚˜ì‚¬ë ›ìƒˆê¿ˆí•™êµ",
                "requester": "ì¡°í˜œì£¼ íŒ€ì¥ë‹˜",
                "email": "tmdgns0927@naver.com",
                "contact": "041-579-1295",
                "phone": "041-579-1295",
                "password": "zxcasd123",
                "masterPassword": "12345",
                "requestDate": "2025-11-11",
                "startDate": "2025-11-11",
                "endDate": "2026-06-30",
                "status": "ì§„í–‰ì¤‘",
                "createdAt": 1762909499281
            },
            {
                "category": "ì‹œë‹ˆì–´100",
                "service": "ìŠ¤ë§ˆíŠ¸ë“œëŸ¼",
                "name": "ì´ì€ì˜",
                "requester": "",
                "email": "ì¹´ì¹´ì˜¤ê°€ì…",
                "contact": "01072759747",
                "phone": "01072759747",
                "password": "",
                "masterPassword": "12345",
                "requestDate": "2025-11-07",
                "startDate": "2025-11-10",
                "endDate": "2025-11-17",
                "status": "ì§„í–‰ì¤‘",
                "createdAt": 1762909102851
            },
            {
                "category": "í•™êµ",
                "service": "ìŠ¤ë§ˆíŠ¸ë“œëŸ¼",
                "name": "ë‚˜ì‚¬ë ›ìƒˆê¿ˆí•™êµ",
                "requester": "ì¡°í˜œì£¼ íŒ€ì¥ë‹˜",
                "email": "tmdgns0927@naver.com",
                "contact": "041-579-1295",
                "phone": "041-579-1295",
                "password": "zxcasd123",
                "masterPassword": "12345",
                "requestDate": "2025-10-27",
                "startDate": "2025-11-04",
                "endDate": "2027-02-28",
                "status": "ì§„í–‰ì¤‘",
                "createdAt": 1762909112291
            },
            {
                "category": "í•™êµ",
                "service": "ìŠ¤ë§ˆíŠ¸ë“œëŸ¼",
                "name": "êµ¬ë•ì´ˆë“±í•™êµ",
                "requester": "ì¡°í˜œì£¼ íŒ€ì¥ë‹˜",
                "email": "goduk2@korea.kr",
                "contact": "051-255-1722",
                "phone": "051-255-1722",
                "password": "zxcasd123",
                "masterPassword": "12345",
                "requestDate": "2025-11-04",
                "startDate": "2025-11-04",
                "endDate": "2027-02-28",
                "status": "ì§„í–‰ì¤‘",
                "createdAt": 1762909117361
            }
        ];

        const $ = s => document.querySelector(s);
        const $$ = s => Array.from(document.querySelectorAll(s));

        const toast = (msg, type = "info") => {
            const t = $("#toast");
            if (!t) return;
            if (t.timeoutId) clearTimeout(t.timeoutId);
            t.textContent = msg;
            t.style.background = type === "error" ? "#f44336" : type === "success" ? "#4CAF50" : "#333";
            t.classList.add("show");
            t.timeoutId = setTimeout(() => t.classList.remove("show"), 2600);
        };

        const escH = s => String(s || "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#039;" }[m]));
        const escA = s => String(s || "").replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;");
        const urlJoin = (...parts) => parts.map(p => String(p || "").replace(/(^\/+|\/+$)/g, "")).filter(Boolean).join("/");

        const todayStr = () => {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${y}-${m}-${day}`;
        };
        const parseDate = s => {
            if (!s) return null;
            const [y, m, d] = s.split("-").map(Number);
            if (!y || !m || !d) return null;
            return new Date(y, m - 1, d);
        };
        const diffInDays = (d1, d2) => {
            const ms = 24 * 60 * 60 * 1000;
            return Math.floor((d2.getTime() - d1.getTime()) / ms);
        };
        const fmtShortDateStr = s => {
            if (!s) return "";
            if (s.length === 10 && s[4] === "-" && s[7] === "-") return s.slice(2); // "2025-11-11" -> "25-11-11"
            return s;
        };
        const nowIso = () => new Date().toISOString();
        const nextId = () => "SR" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);

        let state = {
            data: { meta: DEFAULT_META, records: [] },
            filters: {
                category: "",
                name: "",
                dateType: "requestDate",
                start: "",
                end: "",
                status: "",
                sort: "requestDateDesc" // ì •ë ¬ ìƒíƒœ ì¶”ê°€
            },
            editingId: null,
            deleteTargetId: null
        };

        /* ===== í´ë¦½ë³´ë“œ ë³µì‚¬ ===== */
        function copyToClipboard(text) {
            const t = document.createElement("textarea");
            t.value = text;
            document.body.appendChild(t);
            t.select();
            document.execCommand("copy");
            document.body.removeChild(t);
            toast("í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        }

        /* ===== ì„œë²„ ì €ì¥ ===== */
        async function saveToServer() {
            const payload = { filename: FILE_NAME, content: state.data };

            const tryJsonPost = async (u, useDataKey) => {
                const body = useDataKey
                    ? JSON.stringify({ filename: payload.filename, data: payload.content })
                    : JSON.stringify(payload);
                return fetch(urlJoin(ENDPOINTS.basePath, u), {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body,
                    cache: "no-store"
                });
            };
            const tryFormPost = async (u, useDataKey) => {
                const fd = new FormData();
                fd.append("filename", payload.filename);
                fd.append(useDataKey ? "data" : "content", JSON.stringify(payload.content));
                return fetch(urlJoin(ENDPOINTS.basePath, u), {
                    method: "POST",
                    body: fd,
                    cache: "no-store"
                });
            };

            for (const base of ENDPOINTS.save) {
                try {
                    let r = await tryJsonPost(base, false);
                    if (r.ok) {
                        const j = await r.json().catch(() => null);
                        if (!j || j.success) { toast("ì„œë²„ ì €ì¥ ì™„ë£Œ", "success"); return true; }
                    }
                    r = await tryJsonPost(base, true);
                    if (r.ok) {
                        const j = await r.json().catch(() => null);
                        if (!j || j.success) { toast("ì„œë²„ ì €ì¥ ì™„ë£Œ(data)", "success"); return true; }
                    }
                    r = await tryFormPost(base, false);
                    if (r.ok) {
                        const j = await r.json().catch(() => null);
                        if (!j || j.success) { toast("ì„œë²„ ì €ì¥ ì™„ë£Œ(form)", "success"); return true; }
                    }
                    r = await tryFormPost(base, true);
                    if (r.ok) {
                        const j = await r.json().catch(() => null);
                        if (!j || j.success) { toast("ì„œë²„ ì €ì¥ ì™„ë£Œ(form:data)", "success"); return true; }
                    }
                } catch (e) { console.warn("save error", base, e); }
            }
            toast("âŒ ì €ì¥ ì‹¤íŒ¨ â€” ê²½ë¡œ/ê¶Œí•œ í™•ì¸ í•„ìš”", "error");
            return false;
        }

        /* ===== ì„œë²„ ë¶ˆëŸ¬ì˜¤ê¸° ===== */
        async function loadFromServer() {
            const parseAny = async (res) => {
                if (!res.ok) return null;
                const txt = await res.text();
                try {
                    const j = JSON.parse(txt);
                    if (j && typeof j === "object") {
                        if ("success" in j && j.data !== undefined) return j.data;
                        return j;
                    }
                } catch (_) { }
                return null;
            };

            for (const base of ENDPOINTS.load) {
                try {
                    let u = urlJoin(ENDPOINTS.basePath, base) + `?filename=${encodeURIComponent(FILE_NAME)}&t=${Date.now()}`;
                    let r = await fetch(u, { cache: "no-store" });
                    let data = await parseAny(r);
                    if (!data) {
                        u = urlJoin(ENDPOINTS.basePath, base) + `?file=${encodeURIComponent(FILE_NAME)}&t=${Date.now()}`;
                        r = await fetch(u, { cache: "no-store" });
                        data = await parseAny(r);
                    }
                    if (data) {
                        hydrateData(data);
                        renderAll();
                        toast("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ", "success");
                        return;
                    }
                } catch (e) { console.warn("load error", base, e); }
            }

            try {
                const url = urlJoin(ENDPOINTS.basePath, ENDPOINTS.fallbackJson) + `?t=${Date.now()}`;
                const j = await (await fetch(url, { cache: "no-store" })).json();
                const data = (j?.data?.meta && j?.data?.records) ? j.data : j;
                if (data) {
                    hydrateData(data);
                    renderAll();
                    toast("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ(json)", "success");
                    return;
                }
            } catch (_) { }

            const backup = localStorage.getItem(BACKUP_KEY);
            if (backup) {
                try {
                    hydrateData(JSON.parse(backup));
                    renderAll();
                    toast("âš ï¸ ì„œë²„ ì‹¤íŒ¨ â€” localStorage ì ìš©", "info");
                    return;
                } catch (_) { }
            }

            hydrateData({ meta: DEFAULT_META, records: INITIAL_RECORDS() });
            renderAll();
            toast("âš ï¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ â€” ê¸°ë³¸ê°’ ì‹œì‘", "error");
        }

        /* ===== ì´ˆê¸° ë ˆì½”ë“œ ë³€í™˜ ===== */
        function INITIAL_RECORDS() {
            return INITIAL_RECORDS_RAW.map((r, i) => ({
                id: nextId() + "D" + i,
                category: r.category || "ê¸°íƒ€",
                service: r.service || "",
                name: r.name || "",
                requester: r.requester || "",
                email: r.email || "",
                contact: r.contact || "",
                phone: r.phone || "",
                password: r.password || "",
                masterPassword: r.masterPassword || "",
                requestDate: r.requestDate || "",
                startDate: r.startDate || "",
                endDate: r.endDate || "",
                status: r.status || "ì§„í–‰ì¤‘",
                createdAt: r.createdAt ? new Date(r.createdAt).toISOString() : nowIso(),
                updatedAt: r.createdAt ? new Date(r.createdAt).toISOString() : nowIso()
            }));
        }

        /* ===== ë°ì´í„° í•©ì¹˜ê¸° ===== */
        function hydrateData(incoming) {
            const metaIn = incoming?.meta || {};
            const recIn = Array.isArray(incoming?.records) ? incoming.records : INITIAL_RECORDS();

            const categories = Array.from(new Set([
                ...DEFAULT_META.categories,
                ...(metaIn.categories || [])
            ]));
            const services = Array.from(new Set([
                ...DEFAULT_META.services,
                ...(metaIn.services || [])
            ]));
            const statuses = Array.from(new Set([
                ...DEFAULT_META.statuses,
                ...(metaIn.statuses || [])
            ]));

            state.data.meta = { categories, services, statuses };
            state.data.records = recIn.map(r => ({
                id: r.id || nextId(),
                category: r.category || "ê¸°íƒ€",
                service: r.service || "",
                name: r.name || "",
                requester: r.requester || "",
                email: r.email || "",
                contact: r.contact || "",
                phone: r.phone || "",
                password: r.password || "",
                masterPassword: r.masterPassword || "",
                requestDate: r.requestDate || "",
                startDate: r.startDate || "",
                endDate: r.endDate || "",
                status: r.status || "ì§„í–‰ì¤‘",
                createdAt: r.createdAt || nowIso(),
                updatedAt: r.updatedAt || r.createdAt || nowIso()
            }));

            try { localStorage.setItem(BACKUP_KEY, JSON.stringify(state.data)); } catch (_) { }
        }

        /* ===== ì˜µì…˜ ë Œë”ë§ ===== */
        function renderOptions() {
            const { categories, services, statuses } = state.data.meta;

            // í¼
            $("#fCategory").innerHTML = categories.map(c => `<option value="${escA(c)}">${escH(c)}</option>`).join("");
            $("#fService").innerHTML = services.map(s => `<option value="${escA(s)}">${escH(s)}</option>`).join("");
            $("#fStatus").innerHTML = statuses.map(s => `<option value="${escA(s)}">${escH(s)}</option>`).join("");

            // í•„í„°
            const fc = $("#filterCategory");
            fc.innerHTML = `<option value="">ì „ì²´</option>` + categories.map(c => `<option value="${escA(c)}">${escH(c)}</option>`).join("");
            const fs = $("#filterStatus");
            fs.innerHTML = `<option value="">ì „ì²´</option>` + statuses.map(s => `<option value="${escA(s)}">${escH(s)}</option>`).join("");
        }

        /* ===== í†µê³„ ë Œë”ë§ ===== */
        function renderStats() {
            const list = state.data.records || [];
            const today = parseDate(todayStr());
            let totalActive = 0, soon30 = 0, soon3 = 0, todayEnd = 0, ended = 0;

            list.forEach(r => {
                if (r.status === "ì§„í–‰ì¤‘") totalActive++;
                const end = parseDate(r.endDate);
                if (!end) return;
                const diff = diffInDays(today, end); // end - today
                if (diff === 0) todayEnd++;
                if (diff > 0 && diff <= 3) soon3++;
                if (diff > 0 && diff <= 30) soon30++;
                if (end < today) ended++;
            });

            $("#statTotalActive").textContent = totalActive;
            $("#stat30").textContent = soon30;
            $("#stat3").textContent = soon3;
            $("#statToday").textContent = todayEnd;
            $("#statEnded").textContent = ended;
            $("#summaryLabel").textContent = `ì´ ${list.length}ê±´`;
        }

        /* ===== í•„í„°ëœ ë¦¬ìŠ¤íŠ¸ ===== */
        function getFilteredList() {
            const { category, name, dateType, start, end, status, sort } = state.filters;
            const keyword = (name || "").toLowerCase();
            const sd = start ? parseDate(start) : null;
            const ed = end ? parseDate(end) : null;

            return (state.data.records || []).filter(r => {
                if (category && r.category !== category) return false;
                if (status && r.status !== status) return false;
                if (keyword) {
                    const hay = (r.name || "").toLowerCase();
                    if (!hay.includes(keyword)) return false;
                }
                const targetDate = r[dateType] || "";
                if (sd || ed) {
                    const td = parseDate(targetDate);
                    if (!td) return false;
                    if (sd && td < sd) return false;
                    if (ed && td > ed) return false;
                }
                return true;
            }).sort((a, b) => {
                // 1. ì¢…ë£Œ ìƒíƒœëŠ” ë¬´ì¡°ê±´ í•˜ë‹¨ìœ¼ë¡œ ë³´ëƒ„
                const aEnded = a.status === "ì¢…ë£Œ";
                const bEnded = b.status === "ì¢…ë£Œ";
                if (aEnded && !bEnded) return 1;
                if (!aEnded && bEnded) return -1;

                // 2. ì‚¬ìš©ì ì„ íƒ ì •ë ¬ ê¸°ì¤€ ì ìš©
                // sort ê°’: requestDateDesc(ê¸°ë³¸), requestDateAsc, endDateAsc, endDateDesc
                let key = "requestDate";
                let order = -1; // ë‚´ë¦¼ì°¨ìˆœ(ìµœì‹ ì´ ìœ„ë¡œ/í°ê°’ì´ ìœ„ë¡œ)

                if (sort === "requestDateAsc") { key = "requestDate"; order = 1; }
                else if (sort === "endDateAsc") { key = "endDate"; order = 1; }
                else if (sort === "endDateDesc") { key = "endDate"; order = -1; }

                const valA = a[key] || "";
                const valB = b[key] || "";

                if (valA < valB) return -1 * order;
                if (valA > valB) return 1 * order;

                // ê°’ì´ ê°™ìœ¼ë©´ ìƒì„±ì¼ ì—­ìˆœ(ìµœì‹  ë“±ë¡ìˆœ)
                const ca = a.createdAt || "";
                const cb = b.createdAt || "";
                return cb.localeCompare(ca);
            });
        }

        /* ===== í…Œì´ë¸” ë Œë”ë§ ===== */
        function renderTable() {
            const tbody = $("#tbody");
            const rows = getFilteredList();
            if (!rows.length) {
                tbody.innerHTML = `
        <tr>
          <td colspan="14" style="text-align:center;padding:18px 4px;" class="muted">
            í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.
          </td>
        </tr>`;
                return;
            }
            const statuses = state.data.meta.statuses || [];
            tbody.innerHTML = rows.map(r => {
                const options = statuses.map(s => `<option value="${escA(s)}"${s === r.status ? " selected" : ""}>${escH(s)}</option>`).join("");
                return `
        <tr data-id="${escA(r.id)}">
          <td>${escH(r.category)}</td>
          <td>${escH(r.service)}</td>
          <td>${escH(r.name)}</td>
          <td>${escH(r.requester)}</td>
          <td>${escH(r.email)}</td>
          <td>${escH(r.contact)}</td>
          <td>${escH(r.phone)}</td>
          <td>${escH(r.password)}</td>
          <td>${escH(r.masterPassword)}</td>
          <td>${escH(fmtShortDateStr(r.requestDate || ""))}</td>
          <td>${escH(fmtShortDateStr(r.startDate || ""))}</td>
          <td>${escH(fmtShortDateStr(r.endDate || ""))}</td>
          <td>
            <select class="status-select" data-role="status">
              ${options}
            </select>
          </td>
          <td class="cell-actions">
            <a data-role="copy" class="copy">ë³µì‚¬</a>
            <a data-role="edit">ìˆ˜ì •</a>
            <a data-role="delete" class="delete">ì‚­ì œ</a>
          </td>
        </tr>
      `;
            }).join("");
        }

        /* ===== ì „ì²´ ë Œë” ===== */
        function renderAll() {
            renderOptions();
            renderStats();
            renderTable();
            try { localStorage.setItem(BACKUP_KEY, JSON.stringify(state.data)); } catch (_) { }
        }

        /* ===== í•„í„° UI ì²˜ë¦¬ ===== */
        function applyFilterFromUI() {
            state.filters.category = $("#filterCategory").value || "";
            state.filters.name = $("#filterName").value || "";
            state.filters.dateType = $("#filterDateType").value || "requestDate";
            state.filters.start = $("#filterStart").value || "";
            state.filters.end = $("#filterEnd").value || "";
            state.filters.status = $("#filterStatus").value || "";
            state.filters.sort = $("#filterSort").value || "requestDateDesc"; // ì •ë ¬ ê°’ ì½ê¸°
            renderTable();
            toast("í•„í„° ë° ì •ë ¬ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        function resetFilterUI() {
            $("#filterCategory").value = "";
            $("#filterName").value = "";
            $("#filterDateType").value = "requestDate";
            $("#filterStart").value = "";
            $("#filterEnd").value = "";
            $("#filterStatus").value = "";
            $("#filterSort").value = "requestDateDesc"; // ì •ë ¬ UI ì´ˆê¸°í™”
            state.filters = {
                category: "", name: "", dateType: "requestDate",
                start: "", end: "", status: "", sort: "requestDateDesc"
            };
            renderAll();
            toast("í•„í„°ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
        }

        /* ===== ëª¨ë‹¬ ê´€ë ¨ ===== */
        function openEntryModal() {
            $("#entryModal").classList.add("show");
        }
        function closeEntryModal() {
            $("#entryModal").classList.remove("show");
        }
        function openDeleteModal(id) {
            state.deleteTargetId = id;
            $("#deleteModal").classList.add("show");
        }
        function closeDeleteModal() {
            state.deleteTargetId = null;
            $("#deleteModal").classList.remove("show");
        }

        function clearEntryForm() {
            $("#fCategory").selectedIndex = 0;
            $("#fService").selectedIndex = 0;
            $("#fName").value = "";
            $("#fRequesterSelect").value = "";
            $("#fRequesterCustom").value = "";
            $("#fRequesterCustom").style.display = "none";
            $("#fEmail").value = "";
            $("#fContact").value = "";
            $("#fPhone").value = "";
            $("#fPassword").value = "";
            $("#fMasterPassword").value = "";
            $("#fRequestDate").value = todayStr();
            $("#fStartDate").value = "";
            $("#fEndDate").value = "";
            $("#fStatus").value = "ì§„í–‰ì¤‘";
            state.editingId = null;
            $("#entryModeLabel").textContent = "ì‹ ê·œ ë“±ë¡ ëª¨ë“œ";
            $("#btnDeleteEntry").style.display = "none";
        }

        function fillEntryForm(id) {
            const rec = state.data.records.find(r => r.id === id);
            if (!rec) return;
            state.editingId = id;
            $("#fCategory").value = rec.category;
            $("#fService").value = rec.service;
            $("#fName").value = rec.name;

            const sel = $("#fRequesterSelect");
            const custom = $("#fRequesterCustom");
            if (REQUESTERS.includes(rec.requester)) {
                sel.value = rec.requester;
                custom.style.display = "none";
                custom.value = "";
            } else if (rec.requester) {
                sel.value = "__custom__";
                custom.style.display = "block";
                custom.value = rec.requester;
            } else {
                sel.value = "";
                custom.style.display = "none";
                custom.value = "";
            }

            $("#fEmail").value = rec.email;
            $("#fContact").value = rec.contact;
            $("#fPhone").value = rec.phone;
            $("#fPassword").value = rec.password;
            $("#fMasterPassword").value = rec.masterPassword;
            $("#fRequestDate").value = rec.requestDate || "";
            $("#fStartDate").value = rec.startDate || "";
            $("#fEndDate").value = rec.endDate || "";
            $("#fStatus").value = rec.status;
            $("#entryModeLabel").textContent = "ìˆ˜ì • ëª¨ë“œ";
            $("#btnDeleteEntry").style.display = "inline-flex";
        }

        function collectEntryForm() {
            const category = $("#fCategory").value;
            const service = $("#fService").value;
            const name = $("#fName").value.trim();

            const sel = $("#fRequesterSelect");
            const custom = $("#fRequesterCustom");
            let requester = "";
            if (sel.value === "__custom__") {
                requester = custom.value.trim();
            } else {
                requester = sel.value.trim();
            }

            const email = $("#fEmail").value.trim();
            const contact = $("#fContact").value.trim();
            const phone = $("#fPhone").value.trim();
            const password = $("#fPassword").value.trim();
            const masterPassword = $("#fMasterPassword").value.trim();
            const requestDate = $("#fRequestDate").value;
            const startDate = $("#fStartDate").value;
            const endDate = $("#fEndDate").value;
            const status = $("#fStatus").value;

            if (!name) {
                toast("ê¸°ê´€ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
                $("#fName").focus();
                return null;
            }
            if (!requestDate) {
                toast("ìš”ì²­ë‚ ì§œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "error");
                $("#fRequestDate").focus();
                return null;
            }
            return {
                category, service, name, requester, email, contact, phone,
                password, masterPassword, requestDate, startDate, endDate, status
            };
        }

        function saveEntry() {
            const data = collectEntryForm();
            if (!data) return;
            const now = nowIso();
            if (state.editingId) {
                const rec = state.data.records.find(r => r.id === state.editingId);
                if (!rec) { toast("ìˆ˜ì • ëŒ€ìƒ ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error"); return; }
                Object.assign(rec, data, { updatedAt: now });
                toast("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            } else {
                state.data.records.push({
                    id: nextId(),
                    ...data,
                    createdAt: now,
                    updatedAt: now
                });
                toast("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            }
            try { localStorage.setItem(BACKUP_KEY, JSON.stringify(state.data)); } catch (_) { }
            renderAll();
            saveToServer();
            closeEntryModal();
        }

        function deleteCurrentEntry() {
            if (!state.editingId) return;
            openDeleteModal(state.editingId);
        }

        function performDelete() {
            const id = state.deleteTargetId;
            if (!id) { closeDeleteModal(); return; }
            const idx = state.data.records.findIndex(r => r.id === id);
            if (idx > -1) state.data.records.splice(idx, 1);
            toast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
            try { localStorage.setItem(BACKUP_KEY, JSON.stringify(state.data)); } catch (_) { }
            renderAll();
            saveToServer();
            if (state.editingId === id) {
                clearEntryForm();
                closeEntryModal();
            }
            closeDeleteModal();
        }

        /* ===== ì´ˆê¸°í™” ===== */
        document.addEventListener("DOMContentLoaded", () => {
            hydrateData({ meta: DEFAULT_META, records: INITIAL_RECORDS() });
            renderAll();

            // ìš”ì²­ì ë“œë¡­ë‹¤ìš´ ì§ì ‘ì…ë ¥ í† ê¸€
            const rqSel = $("#fRequesterSelect");
            const rqCustom = $("#fRequesterCustom");
            rqSel.addEventListener("change", () => {
                if (rqSel.value === "__custom__") {
                    rqCustom.style.display = "block";
                    rqCustom.focus();
                } else {
                    rqCustom.style.display = "none";
                    rqCustom.value = "";
                }
            });

            // í•„í„° í† ê¸€
            $("#btnToggleFilter").addEventListener("click", () => {
                const body = $("#filtersBody");
                const hidden = body.style.display === "none";
                body.style.display = hidden ? "flex" : "none";
                $("#btnToggleFilter").textContent = hidden ? "ì ‘ê¸°" : "í¼ì¹˜ê¸°";
            });

            // í•„í„° ì´ë²¤íŠ¸
            $("#btnSearch").addEventListener("click", applyFilterFromUI);
            $("#btnResetFilter").addEventListener("click", resetFilterUI);

            // ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
            $("#btnSave").addEventListener("click", saveToServer);
            $("#btnLoad").addEventListener("click", loadFromServer);

            // ì‹ ê·œ ì‘ì„± (ê²€ìƒ‰ ì˜† ë²„íŠ¼)
            $("#btnWriteRequest").addEventListener("click", () => {
                clearEntryForm();
                openEntryModal();
            });

            // FAB & ëª¨ë‹¬
            $("#btnFab").addEventListener("click", () => {
                clearEntryForm();
                openEntryModal();
            });
            $("#entryClose").addEventListener("click", closeEntryModal);
            $("#entryModal").addEventListener("click", e => {
                if (e.target === $("#entryModal")) closeEntryModal();
            });
            $("#btnClearForm").addEventListener("click", () => {
                clearEntryForm();
                toast("ì…ë ¥ ë‚´ìš©ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
            });
            $("#btnSaveEntry").addEventListener("click", saveEntry);
            $("#btnDeleteEntry").addEventListener("click", deleteCurrentEntry);

            // ì‚­ì œ ëª¨ë‹¬
            $("#btnDeleteCancel").addEventListener("click", closeDeleteModal);
            $("#deleteClose").addEventListener("click", closeDeleteModal);
            $("#btnDeleteOk").addEventListener("click", performDelete);
            $("#deleteModal").addEventListener("click", e => {
                if (e.target === $("#deleteModal")) closeDeleteModal();
            });

            // í…Œì´ë¸” ìƒíƒœ/ìˆ˜ì •/ì‚­ì œ ì´ë²¤íŠ¸ ìœ„ì„
            $("#tbody").addEventListener("change", e => {
                const sel = e.target.closest("select[data-role='status']");
                if (!sel) return;
                const tr = sel.closest("tr[data-id]");
                if (!tr) return;
                const id = tr.getAttribute("data-id");
                const rec = state.data.records.find(r => r.id === id);
                if (!rec) return;
                rec.status = sel.value;
                rec.updatedAt = nowIso();
                renderStats();
                try { localStorage.setItem(BACKUP_KEY, JSON.stringify(state.data)); } catch (_) { }
                saveToServer();
            });

            $("#tbody").addEventListener("click", e => {
                const role = e.target.getAttribute("data-role");
                if (!role) return;
                const tr = e.target.closest("tr[data-id]");
                if (!tr) return;
                const id = tr.getAttribute("data-id");
                
                if (role === "edit") {
                    fillEntryForm(id);
                    openEntryModal();
                } else if (role === "delete") {
                    openDeleteModal(id);
                } else if (role === "copy") {
                    // ë³µì‚¬ ë¡œì§ ë³€ê²½: í´ë¦½ë³´ë“œ ë³µì‚¬ -> ì…ë ¥ì°½ì— ë‚´ìš© ì±„ì›Œ ë„£ê³  ì—´ê¸° (ì‹ ê·œ ë“±ë¡)
                    const rec = state.data.records.find(r => r.id === id);
                    if (rec) {
                        // 1. ê°’ ì±„ìš°ê¸° (fillEntryFormê³¼ ìœ ì‚¬í•˜ì§€ë§Œ editingId ì„¤ì • ì•ˆí•¨)
                        $("#fCategory").value = rec.category;
                        $("#fService").value = rec.service;
                        $("#fName").value = rec.name;

                        // ìš”ì²­ì ì²˜ë¦¬
                        const sel = $("#fRequesterSelect");
                        const custom = $("#fRequesterCustom");
                        if (REQUESTERS.includes(rec.requester)) {
                            sel.value = rec.requester;
                            custom.style.display = "none";
                            custom.value = "";
                        } else if (rec.requester) {
                            sel.value = "__custom__";
                            custom.style.display = "block";
                            custom.value = rec.requester;
                        } else {
                            sel.value = "";
                            custom.style.display = "none";
                            custom.value = "";
                        }

                        $("#fEmail").value = rec.email;
                        $("#fContact").value = rec.contact;
                        $("#fPhone").value = rec.phone;
                        $("#fPassword").value = rec.password;
                        $("#fMasterPassword").value = rec.masterPassword;
                        $("#fRequestDate").value = rec.requestDate || "";
                        $("#fStartDate").value = rec.startDate || "";
                        $("#fEndDate").value = rec.endDate || "";
                        $("#fStatus").value = rec.status;

                        // 2. ì‹ ê·œ ë“±ë¡ ëª¨ë“œë¡œ ì„¤ì • (editingId = null)
                        state.editingId = null; 
                        $("#entryModeLabel").textContent = "ì‹ ê·œ ë“±ë¡ (ë³µì‚¬)";
                        $("#btnDeleteEntry").style.display = "none";

                        // 3. ëª¨ë‹¬ ì—´ê¸°
                        openEntryModal();
                        toast("ì„ íƒí•œ í•­ëª©ì„ ë³µì‚¬í•˜ì—¬ ì…ë ¥ì°½ì„ ì—´ì—ˆìŠµë‹ˆë‹¤.");
                    }
                }
            });

            // ìµœì´ˆ ì„œë²„ ë°ì´í„° ì‹œë„ ë¡œë“œ
            loadFromServer();
        });
    </script>
</body>

</html>